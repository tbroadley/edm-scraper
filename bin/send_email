#!/usr/bin/env ruby

require 'postageapp'

require_relative '../environment'
require_relative '../lib/models/show'
require_relative '../lib/email_builders'

unless Show.unseen.empty?
  PostageApp.configure do |config|
    config.api_key = ENV['POSTAGEAPP_API_KEY']
  end

  request = PostageApp::Request.new(
    :send_message,
    {
      headers: {
        from: ENV['DATABASE_ENV'] == 'production' ? 'edm-scraper@tbroadley.com' : 'edm-scraper-dev@tbroadley.com',
        subject: email_subject,
      },
      recipients: 'buriedunderbooks@hotmail.com',
      content: {
        'text/html': email_body,
      },
    }
  )

  request.send

  Show.unseen.each do |show|
    show.update!(new: false)
  end
end
