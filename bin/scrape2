#!/usr/bin/env ruby

require 'capybara'
require 'capybara/dsl'
require 'capybara/poltergeist'

require_relative '../environment'

include Capybara::DSL

Capybara.register_driver :poltergeist do |app|
  Capybara::Poltergeist::Driver.new(app, js_errors: false)
end

Capybara.default_driver = :poltergeist
Capybara.default_max_wait_time = 0.1

visit('http://concertsto.com/')

current_date = nil

send_email_if_rescue('scrape2') do
  all('#c tr').each do |element|
    if element[:class] == 'date'
      current_date = parse_date_string_2(element.text)
    elsif element[:class].split(' ').include?('c')
      show_and_venue = element.find('.show')
      venue = show_and_venue.find('.venue').text
      name = show_and_venue.text.sub(" #{venue}", '')

      if show_and_venue.first('.new')
        name = name.sub(/[Nn]ew$/, '')
      end

      ticket_link = element.find('.tickets > p:first-child > a')
      url = ticket_link[:href]

      show = Show.new(
        name: name,
        venue: venue,
        start_date: current_date,
        end_date: current_date,
        url: url,
        filter: true,
      )
      show.save
    end
  end
end
