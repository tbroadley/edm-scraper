#!/usr/bin/env ruby
# frozen_string_literal: true

require 'capybara'
require 'capybara/dsl'
require 'capybara/poltergeist'

require_relative '../environment'

include Capybara::DSL

Capybara.register_driver :poltergeist do |app|
  Capybara::Poltergeist::Driver.new(app, js_errors: false, phantomjs_options: [
                                      '--ssl-protocol=tlsv1.2',
                                    ], timeout: 10.minutes)
end

Capybara.default_driver = :poltergeist

send_email_if_rescue('scrape_nyc_2') do
  visit('https://www.ohmyrockness.com/shows?all=true')
  sleep 30

  all('#upcomingShows .row.vevent').each do |element|
    date_element = element.find('.date.dtstart .value-title')
    date = Date.parse(date_element[:title])
    next if date < Date.new(2018, 5, 1) || date > Date.new(2018, 8, 31)

    name_element = element.find('.bands.summary')
    name = name_element.text.delete('*').strip

    venue_element = element.find('.venue .location.vcard.url .fn.org')
    venue = venue_element.text

    ticket_link = element.find('.tickets > .show-more-info')
    url = ticket_link[:href]

    show = Show.new(
      name: name,
      venue: venue,
      start_date: date,
      end_date: date,
      url: url,
      filter: !filter_artist?(show.name)
    )
    puts show.save_and_return_message
  end
end
